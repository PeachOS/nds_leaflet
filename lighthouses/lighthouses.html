<!DOCTYPE html>
<html>
<head>
  <title>Mapbox GL JS debug page</title>
  <meta charset='utf-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src='./lib/mapbox-gl-dev.js'></script>
  <link href='./lib/mapbox-gl.css' rel='stylesheet' />
  <script src="./lib/react.min.js"></script>
  <script src="./lib/react-dom.min.js"></script>
  <script src="./lib/resize.js"></script>


  <style>
   body { margin: 0; padding: 0; }
   html, body, #map { height: 100%; }
   canvas { position: absolute; left:0; top: 0; z-index: 10000; }
  </style>
</head>

<body>
  <div id='map'>
    <canvas id="canvas" width="400" height="400" style="display:none;"></canvas>
  </div>

  <script>


   // -----
   // Canvas resizing and 2D context
   let canvas = document.getElementById('canvas');
   const resizeCanvas = () => {
       let parent = canvas.parentNode, styles = getComputedStyle(parent),
           width = parseInt(styles.getPropertyValue("width"), 10),
           height = parseInt(styles.getPropertyValue("height"), 10);
       canvas.width = width;
       canvas.height = height;
   };
   addResizeListener(document.getElementById('map'), resizeCanvas);
   resizeCanvas();

   let context = canvas.getContext("2d");


   // -----
   // the following canvas example is copied from http://www.html5canvastutorials.com/tutorials/html5-canvas-exploding-dots/
   let points = [], numPoints = 100, i, gravity = 0.1;

   function initPoint(p) {
       p.x = canvas.width / 2;
       p.y = 0;
       p.vx = Math.random() * 6 - 3;
       p.vy = Math.random() * 10;
       p.radius = Math.random() * 4 + 1;
   }

   function updateDots() {
       var i, point, len = points.length;
       for(i = 0; i < len; i += 1) {
           point = points[i];
           point.vy -= gravity;
           point.x += point.vx;
           point.y += point.vy;
           if(point.x > canvas.width ||
              point.x < 0 ||
              point.y > canvas.height ||
              point.y < 0) {
               initPoint(point);
           }
       }
       if(len < numPoints) {
           point = {};
           initPoint(point);
           points.push(point);
       }
   }

   function drawDots() {
       var i, point, len = points.length;
       for(i = 0; i < len; i += 1) {
           point = points[i];
           context.beginPath();
           context.arc(point.x, point.y, point.radius, 0, Math.PI * 2, false);
           context.fillStyle = "#f00";
           context.fill();

       }
   }

   // -----
   // Lighthouses animation
   let lighthouses = null, visible_lighthouses = [];

   function updateLighthouses(timestamp) {
   }

   function drawLighthouses() {
   }

   // -----
   // Anmation loop
   let prevTimestamp = null;
   function loop(timestamp) {
       updateDots();
       updateLighthouses();
       if (timestamp - prevTimestamp > 50) {
           context.clearRect(0, 0, canvas.width, canvas.height);
           drawDots();
           drawLighthouses();
           prevTimestamp = timestamp;
       }
       window.requestAnimationFrame(loop);
   }

   var mapStyle = {
       'version': 8,
       'name': 'Dark',
       'sources': {
           'mapbox': {
               'type': 'vector',
               'url': 'mapbox://mapbox.mapbox-streets-v6'
           },
           'lighthouses': {
               'type': 'geojson',
               'data': './data/lighthouses_kiel.geojson'
           },
           "canvas": {
               "type": 'canvas',
               "canvas": 'canvas',
               "coordinates": [[0, 0], [0, 1], [1, 1], [1, 0]]
           }
       },
       'sprite': 'http://localhost:7777/assets/INT1',
       'glyphs': 'mapbox://fonts/mapbox/{fontstack}/{range}.pbf',
       'layers': [
           {
               'id': 'background',
               'type': 'background',
               'paint': {'background-color': 'hsl(55, 11%, 96%)'}
           },
           {
               'id': 'water',
               'source': 'mapbox',
               'source-layer': 'water',
               'type': 'fill',
               'paint': {'fill-color': 'hsl(185, 9%, 81%)'}
           },
           {
               'id': 'boundaries',
               'source': 'mapbox',
               'source-layer': 'admin',
               'type': 'line',
               'paint': {'line-color': '#797979', 'line-dasharray': [2, 2, 6, 2]},
               'filter': ['all', ['==', 'maritime', 0]]
           },
           {
               'id': 'naval_boundaries',
               'source': 'mapbox',
               'source-layer': 'admin',
               'type': 'line',
               'paint': {'line-color': '#b92dce', 'line-width': 3, 'line-opacity': 0.4},
               'filter': ['all', ['==', 'maritime', 1]]
           },
           {
               'id': 'other_seamarks',
               'source': 'lighthouses',
               'type': 'circle',
               'paint': {'circle-radius': 3, 'circle-color': '#8B88B6'},
               'filter': ['!in', 'seamark:type', 'light_major', 'light_minor', 'landmark']
           },
           {
               'id': 'lighthouses',
               'source': 'lighthouses',
               'type': 'symbol',
               'layout': {
                   'icon-image': '{seamark:type}',
                   'text-field': '{name}',
                   'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                   'text-offset': [0, -1.2],
                   'text-anchor': 'bottom'
               },
               // https://www.mapbox.com/mapbox-gl-js/style-spec/#types-filter
               'filter': ['in', 'seamark:type', 'light_major', 'light_minor', 'landmark']
           },
           {
               'id': 'canvas',
               'source': 'canvas',
               'type': 'raster',
               'paint': {'raster-opacity': 0.85},
               'minzoom': 9,
               'maxzoom': 22
           },
       ]
   };

   mapboxgl.accessToken = 'pk.eyJ1IjoibGJ1ZCIsImEiOiJCVTZFMlRRIn0.0ZQ4d9-WZrekVy7ML89P4A';
   var map = new mapboxgl.Map({
       container: 'map',
       minZoom: 0,
       style: mapStyle,
       hash: false,
       center: [10.2736833, 54.4996167],
       zoom: 10
   });

   const updateCanvas = () => {
       const bounds = map.getBounds();
       let source = map.getSource('canvas');
       source.setCoordinates([bounds.getSouthWest(), bounds.getSouthEast(), bounds.getNorthEast(), bounds.getNorthWest()]);
   };


   map.on('load', function() {

       let source = map.getSource('lighthouses');
       fetch(source.serialize().data)
           .then(response => response.json())
           .then(json => lighthouses = json);

       map.on('moveend', updateCanvas);
       updateCanvas();

       // initialize animation
       loop(performance.now());
   });
  </script>

</body>
</html>
